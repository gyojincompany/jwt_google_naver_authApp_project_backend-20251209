name: Deploy Backend

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # application.yml 자동 생성
      - name: Create application.yml
        run: |
          mkdir -p src/main/resources
          cat <<EOF > src/main/resources/application.yml
          spring:
            datasource:
              url: jdbc:mysql://${DB_HOST}/${DB_NAME}?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
              username: ${DB_USERNAME}
              password: ${DB_PASSWORD}
              driver-class-name: com.mysql.cj.jdbc.Driver

            jpa:
              hibernate:
                ddl-auto: update
              show-sql: true
              properties:
                hibernate:
                  format_sql: true
                  dialect: org.hibernate.dialect.MySQL8Dialect

            security:
              oauth2:
                client:
                  registration:
                    google:
                      client-id: ${GOOGLE_CLIENT_ID}
                      client-secret: ${GOOGLE_CLIENT_SECRET}
                      scope:
                        - email
                        - profile
                      redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"

                    naver:
                      client-id: ${NAVER_CLIENT_ID}
                      client-secret: ${NAVER_CLIENT_SECRET}
                      scope:
                        - name
                        - email
                      client-name: Naver
                      authorization-grant-type: authorization_code
                      redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
                  provider:
                    naver:
                      authorization-uri: https://nid.naver.com/oauth2.0/authorize
                      token-uri: https://nid.naver.com/oauth2.0/token
                      user-info-uri: https://openapi.naver.com/v1/nid/me
                      user-name-attribute: response

          jwt:
            secret: ${JWT_SECRET}
            expiration: 86400000
            refresh-expiration: 604800000

          server:
            port: 8888
          EOF
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Grant execute permission for Gradle
        run: chmod +x ./gradlew

      - name: Build Spring Boot
        run: ./gradlew build -x test

      - name: Copy Jar to EC2
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "build/libs/jwt_test_project-20251209-0.0.1-SNAPSHOT.jar"
          target: "/home/ubuntu/jwt_google_naver_authApp_project_backend-20251209/build/libs"
          strip_components: 2

      - name: Restart backend service
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            sudo systemctl daemon-reload
            sudo systemctl restart backend.service
            sudo systemctl status backend.service --no-pager
